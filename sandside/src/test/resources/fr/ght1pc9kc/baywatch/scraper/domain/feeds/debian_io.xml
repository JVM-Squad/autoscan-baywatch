<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Blog - Simon Vieille</title>
        <link>https://www.deblan.io/</link>
        <description>DevOp anim√© par la culture du libre et du hacking</description>
        <language>fr</language>
        <item>
            <title>
                <![CDATA[Murph v1.23 et Custom Menu v3.11]]>
            </title>
            <link href="https://www.deblan.io/post/658/murph-v1-23-custom-menu-v3-11" type="text/html">https://www.deblan.io/post/658/murph-v1-23-custom-menu-v3-11</link>
            <link href="gemini://deblan.io/posts/658.gmi" type="text/gemini" />
            <description>
                <![CDATA[<p>Je n'ai pas √©crit d'articles depuis quelques temps car mes semaines sont tr√®s charg√©es. Pour autant, je travaille sur de nombreux projets qui me donnent des id√©es de prochains articles.</p><p>Le 1er novembre dernier a √©t√© publi√©e <a href="https://gitnet.fr/murph/murph-core/releases/tag/v1.23.0">la version v1.23</a> de Murph. Murph est un<strong>framework open-source pour construire des CMS</strong>. Il est d√©velopp√© √† l'aide de<strong>Symfony</strong> et permet de g√©rer des sites web avec<strong>plusieurs noms de domaines et en plusieurs langues</strong>. Il est aussi tr√®s efficace pour d√©velopper des outils d'administration et des applications m√©tiers. C'est par ce prisme que j'ai beaucoup exploit√© Murph ces derniers mois, ce qui m'a permis de le mettre √† l'√©preuve. Je l'ai donc agr√©menter de nouvelles fonctionnalit√©s et de correctifs.</p><p><a href="https://doc.murph-project.org/"><img src="/uploads/content/658/screenshot_20231106.png" alt="Documentation Murph" /></a></p><p>Quant √† <a href="https://deblan.gitnet.page/side_menu_doc/">Custom Menu</a>, la version<a href="https://gitnet.fr/deblan/side_menu/releases/tag/v3.11.0">v3.11.0</a> a √©t√© publi√©e de 5 novembre. Elle apporte une nouvelle fonctionnalit√© de recherche des applications dans les diff√©rents menus. Celle permet de filtrer les applications et permettre de les acc√©der plus rapidement. J'y pensais depuis quelques temps et c'est un besoin qui m'a √©t√© r√©mont√©, c'est donc maintenant disponible !</p><p><img src="/uploads/content/658/screenshot_20231106_1.png" alt="Custom Menu" /></p><p><strong>Murph</strong> et<strong>Custom Menu</strong> sont des projets qui me tiennent vraiment √† c≈ìur et je suis heureux de les voir √™tre utilis√©s par d'autres personnes que moi üòÅ</p>
]]>
            </description>
            <guid isPermaLink="false">658</guid>
            <pubDate>Mon, 06 Nov 2023 11:30:00 +0100</pubDate>
            <category>
                <![CDATA[D√©veloppement]]>
            </category>
            <category>
                <![CDATA[Logiciel libre]]>
            </category>
            <category>
                <![CDATA[Projets personnels]]>
            </category>
        </item>
        <item>
            <title>
                <![CDATA[Matrix-Synapse : migrer de SQLite √† PostgreSQL]]>
            </title>
            <link href="https://www.deblan.io/post/655/matrix-synapse-migrer-de-sqlite-a-postgresql" type="text/html">https://www.deblan.io/post/655/matrix-synapse-migrer-de-sqlite-a-postgresql</link>
            <link href="gemini://deblan.io/posts/655.gmi" type="text/gemini" />
            <description>
                <![CDATA[<p>Matrix-Synapse est un service de messagerie d√©centralis√© et interop√©rable avec d'autres messageries. Je l'utilise √† titre personnel et dans le cadre d'une association. Il livre un service que je consid√®re sensible, c'est pourquoi les diff√©rentes instances sont h√©berg√©es sur des infras que je g√®re.</p><p>La configuration par d√©faut stocke les donn√©es de la messagerie dans une base de donn√©es SQLite. Cela a bien fonctionn√© pendant quelques ann√©es mais la base de donn√©es devient tr√®s rapidement ob√®se (plusieurs Go) et SQLite n'est plus adapt√©. C'est d'ailleurs recommand√© d'utiliser PostgreSQL, naturellement plus adapt√© compte tenu de la grande quantit√© de donn√©es.</p><p>Voici la d√©marche pour basculer vers PostgreSQL depuis une base SQLite. J'√©volue sur des machines sous Debian et j'ai install√© Matrix-Synapse via <a href="https://matrix-org.github.io/synapse/latest/setup/installation.html">les packages livr√©s par matrix.org</a>.</p><p>Quelques recomandations avant d'op√©rer la migration :</p><ul><li>Avoir l'espace disque n√©cessaire pour accueillir une copie de la base de donn√©es SQLite</li><li>Avoir l'espace disque n√©cessaire pour h√©berger les donn√©es dans PostgreSQL</li><li>Communiquer aupr√®s de vos utilisateur¬∑rice¬∑s car la proc√©dure prendra des heures et le service sera inaccessible</li></ul><p>La premi√®re √©tape est de stopper le service et de faire une copie de la base de donn√©es. Je vous invite, si vous le pouvez, √† duppliquer la copie de la base sur une autre machine.</p><pre><code class="window language-bash">$ sudo systemctl stop matrix-synapse.service
$ sudo cp -v /var/lib/matrix-synapse/homeserver.db{,.bk}
</code></pre><p>Ensuite, il faut installer PostgreSQL. Je reprend la proc√©dure de la <a href="https://www.postgresql.org/download/linux/debian/">documentation officielle</a>.</p><pre><code class="window language-bash">$ sudo sh -c 'echo "deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" &gt; /etc/apt/sources.list.d/pgdg.list'
$ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
$ sudo apt-get update
$ sudo apt-get -y install postgresql
$ passwd postgres # Changement du mot de passe de l'utilisateur "postgres"
</code></pre><p>√âditer le fichier <code>/etc/postgresql/15/main/pg_hba.conf</code> puis op√©rer ces modifications :</p><pre><code class="window language-diff">-local   all             postgres                                peer
+local   all             all                                     peer
-host    all             all             127.0.0.1/32            scram-sha-256
+host    all             all             127.0.0.1/32            md5
-host    all             all             ::1/128                 scram-sha-256
+host    all             all             ::1/128                 md5
</code></pre><p>On relance ensuite PostgreSQL :</p><pre><code class="window language-bash">$ sudo systemctl start postgresql.service
</code></pre><p>C'est maintenant le moment de cr√©er une base et un compte nomm√©s <code>matrix</code>.</p><pre><code class="window language-bash">$ su - postgres
$ createuser --pwprompt matrix # Conserver le mot de passe que vous allez saisir pour plus tard
$ createdb -e -E UNICODE --template=template0  --locale=C -O matrix matrix
$ psql -d matrix
synapse=# GRANT ALL ON SCHEMA public TO matrix;
</code></pre><p>Avant de lancer le script de migration, il faut duppliquer temporairement le contenu de <code>/etc/matrix-synapse/conf.d/server_name.yaml</code> dans<code>/etc/matrix-synapse/homeserver.yaml</code>. √âditer le fichier<code>/etc/matrix-synapse/homeserver.yaml</code> pour changer la configuration de la base de donn√©es :</p><pre><code class="window language-yaml">database:
  name: psycopg2
  args:
    host: 127.0.0.1
    port: 5432
    user: matrix
    password: "$3cr‚Ç¨t" # Indiquer le mot de passe saisi lors de la cr√©ation d'utilisateur
    database: matrix
    cp_min: 5
    cp_max: 10
</code></pre><p>Vous pouvez maintenant lancer la migration. Cela prendre un temps plus ou moins important selon le nombre d'enregistrements. Une base de donn√©es de 10Go a √©t√© migr√©e en 3 heures. Je vous invite √† lancer la commande dans une session <code>tmux</code> ou<code>screen</code>.</p><pre><code class="window language-bash">$ sudo apt-get install tmux
$ tmux
$ synapse_port_db --curses \
    --sqlite-database /var/lib/matrix-synapse/homeserver.db \
    --postgres-config /etc/matrix-synapse/homeserver.yaml
</code></pre><p>Une fois la migration termin√©e, vous pourrez supprimer le contenu duppliqu√© de <code>/etc/matrix-synapse/conf.d/server_name.yaml</code> et relancer le service.</p><pre><code class="window language-bash">$ sudo systemctl start matrix-synapse.service
</code></pre><p>Dans le cas o√π il y aurait un probl√®me, vous pouvez analyser les logs de Matrix-Synapse dans <code>/var/log/matrix-synapse/homeserver.log</code>. De mon cot√©, j'ai du faire une ou deux requ√™tes pour corriger des compteurs et tout √©tait document√© dans ces logs.</p><p>Je pense avoir donn√© toutes les indications pour que cela se passe bien. N'h√©sitez pas √† laisser un commentaire si vous rencontrez un probl√®me.</p>
]]>
            </description>
            <guid isPermaLink="false">655</guid>
            <pubDate>Sun, 10 Sep 2023 18:30:00 +0200</pubDate>
            <category>
                <![CDATA[Informatique]]>
            </category>
        </item>
    </channel>
</rss>
